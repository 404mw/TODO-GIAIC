openapi: 3.1.0
info:
  title: Perpetua Flow Backend API
  description: |
    Backend API for Perpetua Flow task management application.

    ## Authentication
    All endpoints except `/auth/*` and `/health/*` require JWT Bearer authentication.

    ## Rate Limiting
    - General API: 100 requests/minute per user
    - AI Endpoints: 20 requests/minute per user
    - Auth Endpoints: 10 requests/minute per IP

    ## Idempotency
    POST and PATCH requests require `Idempotency-Key` header (UUID v4).
  version: 1.0.0
  contact:
    name: Perpetua Flow Team
  license:
    name: MIT

servers:
  - url: http://localhost:8000/api/v1
    description: Local development
  - url: https://api.perpetua.flow/api/v1
    description: Production

tags:
  - name: Authentication
    description: OAuth and token management
  - name: Tasks
    description: Task CRUD operations
  - name: Subtasks
    description: Subtask management
  - name: Notes
    description: Notes and voice recordings
  - name: Reminders
    description: Task reminders
  - name: AI
    description: AI-powered features
  - name: Achievements
    description: Gamification and achievements
  - name: Subscription
    description: Pro subscription management
  - name: Notifications
    description: User notifications
  - name: Recovery
    description: Data recovery
  - name: Focus
    description: Focus mode tracking
  - name: Health
    description: Health checks

paths:
  # Authentication
  /auth/google/callback:
    post:
      tags: [Authentication]
      summary: Exchange OAuth code for tokens
      operationId: authGoogleCallback
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GoogleAuthRequest'
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/refresh:
    post:
      tags: [Authentication]
      summary: Refresh access token
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: Tokens refreshed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/logout:
    post:
      tags: [Authentication]
      summary: Logout and revoke refresh token
      operationId: logout
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogoutRequest'
      responses:
        '204':
          description: Logged out successfully

  # Tasks
  /tasks:
    get:
      tags: [Tasks]
      summary: List tasks
      operationId: listTasks
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/offset'
        - $ref: '#/components/parameters/limit'
        - name: completed
          in: query
          schema:
            type: boolean
        - name: priority
          in: query
          schema:
            $ref: '#/components/schemas/TaskPriority'
        - name: hidden
          in: query
          schema:
            type: boolean
            default: false
        - name: due_before
          in: query
          schema:
            type: string
            format: date-time
        - name: due_after
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Task list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags: [Tasks]
      summary: Create task
      operationId: createTask
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/idempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskCreate'
      responses:
        '201':
          description: Task created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'

  /tasks/{id}:
    get:
      tags: [Tasks]
      summary: Get task by ID
      operationId: getTask
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/taskId'
      responses:
        '200':
          description: Task details with subtasks and reminders
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskDetailResponse'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [Tasks]
      summary: Update task
      operationId: updateTask
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/taskId'
        - $ref: '#/components/parameters/idempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskUpdate'
      responses:
        '200':
          description: Task updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '409':
          $ref: '#/components/responses/Conflict'

    delete:
      tags: [Tasks]
      summary: Delete task
      operationId: deleteTask
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/taskId'
      responses:
        '200':
          description: Task deleted, tombstone created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteResponse'

  /tasks/{id}/force-complete:
    post:
      tags: [Tasks]
      summary: Force complete task and all subtasks
      operationId: forceCompleteTask
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/taskId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VersionRequest'
      responses:
        '200':
          description: Task force-completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'

  # Subtasks
  /tasks/{task_id}/subtasks:
    post:
      tags: [Subtasks]
      summary: Create subtask
      operationId: createSubtask
      security:
        - bearerAuth: []
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/idempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubtaskCreate'
      responses:
        '201':
          description: Subtask created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubtaskResponse'
        '409':
          description: Subtask limit exceeded

  /tasks/{task_id}/subtasks/reorder:
    put:
      tags: [Subtasks]
      summary: Reorder subtasks
      operationId: reorderSubtasks
      security:
        - bearerAuth: []
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubtaskReorder'
      responses:
        '200':
          description: Subtasks reordered
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Subtask'

  /subtasks/{id}:
    patch:
      tags: [Subtasks]
      summary: Update subtask
      operationId: updateSubtask
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/idempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubtaskUpdate'
      responses:
        '200':
          description: Subtask updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubtaskResponse'

    delete:
      tags: [Subtasks]
      summary: Delete subtask
      operationId: deleteSubtask
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Subtask deleted

  # Notes
  /notes:
    get:
      tags: [Notes]
      summary: List notes
      operationId: listNotes
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/offset'
        - $ref: '#/components/parameters/limit'
        - name: archived
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Note list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteListResponse'

    post:
      tags: [Notes]
      summary: Create note
      operationId: createNote
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/idempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NoteCreate'
      responses:
        '201':
          description: Note created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteResponse'

  /notes/{id}/convert:
    post:
      tags: [Notes]
      summary: Convert note to task (AI-powered)
      operationId: convertNote
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Task suggestion returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoteConvertResponse'
        '402':
          $ref: '#/components/responses/InsufficientCredits'

  # AI
  /ai/chat:
    post:
      tags: [AI]
      summary: AI chat (SSE streaming)
      operationId: aiChat
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AIChatRequest'
      responses:
        '200':
          description: Streaming response
          content:
            text/event-stream:
              schema:
                type: string
        '402':
          $ref: '#/components/responses/InsufficientCredits'
        '429':
          $ref: '#/components/responses/RateLimited'

  /ai/generate-subtasks:
    post:
      tags: [AI]
      summary: Generate subtasks for task
      operationId: generateSubtasks
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateSubtasksRequest'
      responses:
        '200':
          description: Subtask suggestions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateSubtasksResponse'
        '402':
          $ref: '#/components/responses/InsufficientCredits'

  /ai/confirm-action:
    post:
      tags: [AI]
      summary: Confirm AI-suggested action
      operationId: confirmAIAction
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmActionRequest'
      responses:
        '200':
          description: Action executed
          content:
            application/json:
              schema:
                type: object

  /ai/transcribe:
    post:
      tags: [AI]
      summary: Transcribe voice recording (Pro only)
      operationId: transcribe
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TranscribeRequest'
      responses:
        '200':
          description: Transcription result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranscribeResponse'
        '402':
          $ref: '#/components/responses/InsufficientCredits'
        '403':
          $ref: '#/components/responses/TierRequired'

  /ai/credits:
    get:
      tags: [AI]
      summary: Get credit balance
      operationId: getCredits
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Credit balance
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreditBalanceResponse'

  # Achievements
  /achievements:
    get:
      tags: [Achievements]
      summary: Get user achievements and progress
      operationId: getAchievements
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Achievement data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AchievementsResponse'

  # Subscription
  /subscription:
    get:
      tags: [Subscription]
      summary: Get subscription status
      operationId: getSubscription
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Subscription status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionResponse'

  /subscription/checkout:
    post:
      tags: [Subscription]
      summary: Create checkout session
      operationId: createCheckout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Checkout URL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutResponse'

  /subscription/cancel:
    post:
      tags: [Subscription]
      summary: Cancel subscription
      operationId: cancelSubscription
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Subscription cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancelResponse'

  /webhooks/checkout:
    post:
      tags: [Subscription]
      summary: Checkout.com webhook handler
      operationId: checkoutWebhook
      parameters:
        - name: Cko-Signature
          in: header
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook processed
        '400':
          description: Invalid signature

  # Notifications
  /notifications:
    get:
      tags: [Notifications]
      summary: List notifications
      operationId: listNotifications
      security:
        - bearerAuth: []
      parameters:
        - name: unread_only
          in: query
          schema:
            type: boolean
            default: false
        - $ref: '#/components/parameters/limit'
      responses:
        '200':
          description: Notification list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationListResponse'

  /notifications/{id}/read:
    patch:
      tags: [Notifications]
      summary: Mark notification as read
      operationId: markNotificationRead
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Notification marked read

  /notifications/read-all:
    post:
      tags: [Notifications]
      summary: Mark all notifications as read
      operationId: markAllRead
      security:
        - bearerAuth: []
      responses:
        '200':
          description: All marked read
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      marked_count:
                        type: integer

  # Recovery
  /recovery/tombstones:
    get:
      tags: [Recovery]
      summary: List recoverable items
      operationId: listTombstones
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Tombstone list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TombstoneListResponse'

  /tasks/recover/{tombstone_id}:
    post:
      tags: [Recovery]
      summary: Recover deleted task
      operationId: recoverTask
      security:
        - bearerAuth: []
      parameters:
        - name: tombstone_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Task recovered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  # Focus
  /focus/start:
    post:
      tags: [Focus]
      summary: Start focus session
      operationId: startFocus
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FocusStartRequest'
      responses:
        '200':
          description: Focus session started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FocusResponse'

  /focus/end:
    post:
      tags: [Focus]
      summary: End focus session
      operationId: endFocus
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FocusEndRequest'
      responses:
        '200':
          description: Focus session ended
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FocusResponse'

  # Health
  /health/live:
    get:
      tags: [Health]
      summary: Liveness probe
      operationId: healthLive
      responses:
        '200':
          description: Service is alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /health/ready:
    get:
      tags: [Health]
      summary: Readiness probe
      operationId: healthReady
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthReadyResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    offset:
      name: offset
      in: query
      schema:
        type: integer
        minimum: 0
        default: 0
    limit:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 25
    taskId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    idempotencyKey:
      name: Idempotency-Key
      in: header
      required: true
      schema:
        type: string
        format: uuid

  responses:
    BadRequest:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Forbidden:
      description: Access denied
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Conflict:
      description: Version conflict or limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    InsufficientCredits:
      description: Not enough AI credits
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    TierRequired:
      description: Pro subscription required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    RateLimited:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    # Common
    Error:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: array
              items:
                type: object
            request_id:
              type: string

    Pagination:
      type: object
      properties:
        offset:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        has_more:
          type: boolean

    # Auth
    GoogleAuthRequest:
      type: object
      required: [code, redirect_uri]
      properties:
        code:
          type: string
        redirect_uri:
          type: string

    AuthResponse:
      type: object
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
        user:
          $ref: '#/components/schemas/User'

    RefreshRequest:
      type: object
      required: [refresh_token]
      properties:
        refresh_token:
          type: string

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        token_type:
          type: string
        expires_in:
          type: integer

    LogoutRequest:
      type: object
      required: [refresh_token]
      properties:
        refresh_token:
          type: string

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        name:
          type: string
        avatar_url:
          type: string
          nullable: true
        tier:
          $ref: '#/components/schemas/Tier'
        created_at:
          type: string
          format: date-time

    Tier:
      type: string
      enum: [free, pro]

    # Tasks
    TaskPriority:
      type: string
      enum: [low, medium, high]

    CompletedBy:
      type: string
      enum: [manual, auto, force]
      nullable: true

    Task:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
        description:
          type: string
        priority:
          $ref: '#/components/schemas/TaskPriority'
        due_date:
          type: string
          format: date-time
          nullable: true
        estimated_duration:
          type: integer
          nullable: true
        focus_time_seconds:
          type: integer
        completed:
          type: boolean
        completed_at:
          type: string
          format: date-time
          nullable: true
        completed_by:
          $ref: '#/components/schemas/CompletedBy'
        hidden:
          type: boolean
        archived:
          type: boolean
        template_id:
          type: string
          format: uuid
          nullable: true
        subtask_count:
          type: integer
        subtask_completed_count:
          type: integer
        version:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    TaskCreate:
      type: object
      required: [title]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        description:
          type: string
          maxLength: 2000
        priority:
          $ref: '#/components/schemas/TaskPriority'
        due_date:
          type: string
          format: date-time
        estimated_duration:
          type: integer
          minimum: 1
          maximum: 720

    TaskUpdate:
      type: object
      required: [version]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        description:
          type: string
          maxLength: 2000
        priority:
          $ref: '#/components/schemas/TaskPriority'
        due_date:
          type: string
          format: date-time
          nullable: true
        estimated_duration:
          type: integer
          nullable: true
        completed:
          type: boolean
        hidden:
          type: boolean
        version:
          type: integer

    TaskResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Task'

    TaskDetailResponse:
      type: object
      properties:
        data:
          allOf:
            - $ref: '#/components/schemas/Task'
            - type: object
              properties:
                subtasks:
                  type: array
                  items:
                    $ref: '#/components/schemas/Subtask'
                reminders:
                  type: array
                  items:
                    $ref: '#/components/schemas/Reminder'

    TaskListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Task'
        pagination:
          $ref: '#/components/schemas/Pagination'

    DeleteResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            tombstone_id:
              type: string
              format: uuid
            recoverable_until:
              type: string
              format: date-time

    VersionRequest:
      type: object
      required: [version]
      properties:
        version:
          type: integer

    # Subtasks
    Subtask:
      type: object
      properties:
        id:
          type: string
          format: uuid
        task_id:
          type: string
          format: uuid
        title:
          type: string
        completed:
          type: boolean
        completed_at:
          type: string
          format: date-time
          nullable: true
        order_index:
          type: integer
        source:
          type: string
          enum: [user, ai]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    SubtaskCreate:
      type: object
      required: [title]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200

    SubtaskUpdate:
      type: object
      properties:
        title:
          type: string
        completed:
          type: boolean

    SubtaskResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Subtask'

    SubtaskReorder:
      type: object
      required: [subtask_ids]
      properties:
        subtask_ids:
          type: array
          items:
            type: string
            format: uuid

    # Reminders
    Reminder:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [before, after, absolute]
        offset_minutes:
          type: integer
          nullable: true
        scheduled_at:
          type: string
          format: date-time
        method:
          type: string
          enum: [push, in_app]
        fired:
          type: boolean

    # Notes
    Note:
      type: object
      properties:
        id:
          type: string
          format: uuid
        content:
          type: string
        archived:
          type: boolean
        voice_url:
          type: string
          nullable: true
        voice_duration_seconds:
          type: integer
          nullable: true
        transcription_status:
          type: string
          enum: [pending, completed, failed]
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    NoteCreate:
      type: object
      required: [content]
      properties:
        content:
          type: string
          minLength: 1
          maxLength: 2000
        voice_url:
          type: string
        voice_duration_seconds:
          type: integer

    NoteResponse:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/Note'

    NoteListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Note'
        pagination:
          $ref: '#/components/schemas/Pagination'

    NoteConvertResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            suggested_task:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                priority:
                  $ref: '#/components/schemas/TaskPriority'
                due_date:
                  type: string
                  format: date-time
                  nullable: true
            credits_remaining:
              type: integer

    # AI
    AIChatRequest:
      type: object
      required: [message]
      properties:
        message:
          type: string
        context:
          type: object
          properties:
            include_tasks:
              type: boolean
            task_limit:
              type: integer

    GenerateSubtasksRequest:
      type: object
      required: [task_id]
      properties:
        task_id:
          type: string
          format: uuid

    GenerateSubtasksResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            suggested_subtasks:
              type: array
              items:
                type: object
                properties:
                  title:
                    type: string
            credits_used:
              type: integer
            credits_remaining:
              type: integer

    ConfirmActionRequest:
      type: object
      required: [action_type, action_data]
      properties:
        action_type:
          type: string
        action_data:
          type: object

    TranscribeRequest:
      type: object
      required: [audio_url, duration_seconds]
      properties:
        audio_url:
          type: string
        duration_seconds:
          type: integer

    TranscribeResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            transcription:
              type: string
            language:
              type: string
            confidence:
              type: number
            credits_used:
              type: integer
            credits_remaining:
              type: integer

    CreditBalanceResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            balance:
              type: object
              properties:
                daily_free:
                  type: integer
                subscription:
                  type: integer
                purchased:
                  type: integer
                total:
                  type: integer
            daily_reset_at:
              type: string
              format: date-time
            tier:
              $ref: '#/components/schemas/Tier'

    # Achievements
    AchievementsResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            stats:
              type: object
              properties:
                lifetime_tasks_completed:
                  type: integer
                current_streak:
                  type: integer
                longest_streak:
                  type: integer
                focus_completions:
                  type: integer
                notes_converted:
                  type: integer
            unlocked:
              type: array
              items:
                $ref: '#/components/schemas/Achievement'
            progress:
              type: array
              items:
                $ref: '#/components/schemas/AchievementProgress'
            effective_limits:
              type: object
              properties:
                max_tasks:
                  type: integer
                max_notes:
                  type: integer
                daily_ai_credits:
                  type: integer

    Achievement:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        unlocked_at:
          type: string
          format: date-time
        perk:
          type: object
          properties:
            type:
              type: string
            value:
              type: integer

    AchievementProgress:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        current:
          type: integer
        threshold:
          type: integer
        unlocked:
          type: boolean

    # Subscription
    SubscriptionResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            tier:
              $ref: '#/components/schemas/Tier'
            status:
              type: string
              enum: [active, past_due, grace, cancelled, expired]
            current_period_end:
              type: string
              format: date-time
            cancel_at_period_end:
              type: boolean
            features:
              type: object

    CheckoutResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            checkout_url:
              type: string
            session_id:
              type: string

    CancelResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            status:
              type: string
            access_until:
              type: string
              format: date-time

    # Notifications
    Notification:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [reminder, achievement, subscription, system]
        title:
          type: string
        body:
          type: string
        action_url:
          type: string
          nullable: true
        read:
          type: boolean
        created_at:
          type: string
          format: date-time

    NotificationListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Notification'
        unread_count:
          type: integer

    # Recovery
    Tombstone:
      type: object
      properties:
        id:
          type: string
          format: uuid
        entity_type:
          type: string
          enum: [task, note]
        entity_id:
          type: string
          format: uuid
        deleted_at:
          type: string
          format: date-time
        preview:
          type: object
          properties:
            title:
              type: string

    TombstoneListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Tombstone'

    # Focus
    FocusStartRequest:
      type: object
      required: [task_id]
      properties:
        task_id:
          type: string
          format: uuid

    FocusEndRequest:
      type: object
      required: [task_id, duration_seconds]
      properties:
        task_id:
          type: string
          format: uuid
        duration_seconds:
          type: integer

    FocusResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            task_id:
              type: string
              format: uuid
            focus_time_seconds:
              type: integer

    # Health
    HealthReadyResponse:
      type: object
      properties:
        status:
          type: string
        checks:
          type: object
          properties:
            database:
              type: string
            cache:
              type: string
            ai_service:
              type: string

security:
  - bearerAuth: []
