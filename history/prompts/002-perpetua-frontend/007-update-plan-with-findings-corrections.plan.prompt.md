---
id: 007
title: Update Plan With Findings Corrections
stage: plan
date: 2026-02-19
surface: agent
model: claude-sonnet-4-6
feature: 002-perpetua-frontend
branch: 002-perpetua-frontend
user: 404mw
command: /sp.plan
labels: ["plan", "api-contract", "bug-fix", "security", "architecture"]
links:
  spec: specs/002-perpetua-frontend/spec.md
  ticket: null
  adr: null
  pr: null
files:
  - specs/002-perpetua-frontend/plan.md
tests:
  - "n/a ‚Äî planning artifact only"
---

## Prompt

feature: 002
detailed findings: @FINDINGS.md

user prompt:
regenerate tasks.md with the updated requirements as acceptance criteria.

(Clarification: user intended to update plan.md, not tasks.md.)

## Response snapshot

Updated `specs/002-perpetua-frontend/plan.md` (v1.0 ‚Üí v1.1) with surgical corrections derived from `FINDINGS.md`:

**Targeted edits to existing sections:**
- **Section 3A (Server State hooks)**: Fixed `useCompleteTask()` ‚Üí `useForceCompleteTask({ taskId, version })` with correct endpoint and response schema; fixed `useSubtasks` signature to add `options?: { enabled?: boolean }`; fixed `useNotes` to be task-scoped (`useNotes(taskId: string)`, `POST /tasks/${taskId}/notes`, `apiClient.patch` not `.put`)
- **Layer 4 (API Client)**: Added security note on localStorage token storage; flagged planned HttpOnly cookie migration
- **Layer 5 (AuthContext)**: Added S-01/S-03 security notes on token storage and console.log
- **Schema table**: Added `ForceCompleteResponseSchema` entry documenting `{ data: { task, unlocked_achievements[], streak } }`
- **Pattern 4 (Optimistic UI)**: Updated code example to use `useForceCompleteTask({ taskId, version })` and handle `unlocked_achievements` from response
- **Section 5.1 (Data Flow)**: Fixed hook name and added `version` to request body and `ForceCompleteResponseSchema` to response validation

**New additions:**
- **Pattern 7 (Lazy Query Pattern)**: Documents `enabled: isExpanded` technique with full code example; explains why unconditional queries in list components cause N√órequest floods
- **Section XI (Known Defects & Corrections)**: 8 subsections (XI.1‚ÄìXI.8) covering all FINDINGS.md violations with: what was built, what API.md specifies, the architectural rule violated, and the tasks.md reference for the fix

Plan version bumped to 1.1.0.

## Outcome

- ‚úÖ Impact: plan.md now accurately documents the correct API contracts and architectural decisions; incorrect hook names/signatures removed; Section XI serves as a durable record of known violations for any developer onboarding
- üß™ Tests: n/a (planning artifact)
- üìÅ Files: specs/002-perpetua-frontend/plan.md
- üîÅ Next prompts: `/sp.implement` targeting Phase 14 tasks in the order specified in tasks.md
- üß† Reflection: The initial plan.md was auto-generated by reverse-engineering the codebase ‚Äî so it faithfully documented the bugs. FINDINGS.md provided the API.md ground truth needed to correct it. Going forward, plan.md is the authoritative architectural reference.

## Evaluation notes (flywheel)

- Failure modes observed: Initial /sp.plan run wrote to tasks.md instead of plan.md (user clarified intent)
- Graders run and results (PASS/FAIL): n/a
- Prompt variant (if applicable): sp.plan with FINDINGS.md context
- Next experiment: run /sp.implement to execute Phase 14 bug fixes
